<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lockout Manager Tests</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4A90E2;
            padding-bottom: 10px;
        }
        .test-suite {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #ddd;
            background: #fafafa;
        }
        .test-case.pass {
            border-left-color: #4CAF50;
            background: #f1f8f4;
        }
        .test-case.fail {
            border-left-color: #f44336;
            background: #fef5f5;
        }
        .test-name {
            font-weight: bold;
            margin-bottom: 8px;
        }
        .test-result {
            font-size: 0.9em;
            color: #666;
        }
        .test-error {
            color: #f44336;
            font-family: monospace;
            margin-top: 8px;
            padding: 8px;
            background: #ffe0e0;
            border-radius: 4px;
        }
        .summary {
            background: #4A90E2;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .summary.all-pass {
            background: #4CAF50;
        }
        .summary.has-fail {
            background: #f44336;
        }
        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>üîí Lockout Manager Unit Tests</h1>
    
    <div class="controls">
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearTestData()">Clear Test Data</button>
    </div>
    
    <div id="test-results"></div>
    
    <!-- Load dependencies -->
    <script src="../js/crypto-utils.js"></script>
    <script src="../js/storage-utils.js"></script>
    <script src="../js/event-logger.js"></script>
    <script src="../js/lockout-manager.js"></script>
    
    <script>
        // Test framework
        class TestRunner {
            constructor() {
                this.results = [];
            }
            
            async test(name, fn) {
                try {
                    await fn();
                    this.results.push({ name, status: 'pass' });
                    return true;
                } catch (error) {
                    this.results.push({ name, status: 'fail', error: error.message });
                    return false;
                }
            }
            
            assert(condition, message) {
                if (!condition) {
                    throw new Error(message || 'Assertion failed');
                }
            }
            
            assertEqual(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(
                        message || `Expected ${expected}, got ${actual}`
                    );
                }
            }
            
            assertGreaterThan(actual, value, message) {
                if (actual <= value) {
                    throw new Error(
                        message || `Expected ${actual} to be greater than ${value}`
                    );
                }
            }
            
            assertLessThan(actual, value, message) {
                if (actual >= value) {
                    throw new Error(
                        message || `Expected ${actual} to be less than ${value}`
                    );
                }
            }
            
            renderResults() {
                const container = document.getElementById('test-results');
                const passed = this.results.filter(r => r.status === 'pass').length;
                const failed = this.results.filter(r => r.status === 'fail').length;
                
                let html = `
                    <div class="summary ${failed === 0 ? 'all-pass' : 'has-fail'}">
                        <h2>Test Results: ${passed} passed, ${failed} failed</h2>
                    </div>
                `;
                
                html += '<div class="test-suite">';
                this.results.forEach(result => {
                    html += `
                        <div class="test-case ${result.status}">
                            <div class="test-name">
                                ${result.status === 'pass' ? '‚úÖ' : '‚ùå'} ${result.name}
                            </div>
                            ${result.error ? `<div class="test-error">Error: ${result.error}</div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            }
        }
        
        const runner = new TestRunner();
        
        // Test Suite
        async function runAllTests() {
            console.log('Starting tests...');
            runner.results = [];
            
            // Initialize lockout manager for tests
            await lockoutManager.init();
            await lockoutManager.reset();
            
            // Test 1: Initial state
            await runner.test('Initial state should be clean', async () => {
                const state = lockoutManager.getState();
                runner.assertEqual(state.failureCount, 0, 'Failure count should be 0');
                runner.assertEqual(state.currentLevel, 0, 'Level should be 0');
                runner.assertEqual(state.isLockedOut, false, 'Should not be locked out');
            });
            
            // Test 2: Record single failure
            await runner.test('Record single failure', async () => {
                await lockoutManager.reset();
                const result = await lockoutManager.recordFailure();
                runner.assertEqual(result.level, 0, 'Level should be 0 after 1 failure');
                runner.assertEqual(result.isLockedOut, false, 'Should not be locked out');
                
                const state = lockoutManager.getState();
                runner.assertEqual(state.failureCount, 1, 'Failure count should be 1');
            });
            
            // Test 3: Level 1 lockout (3 attempts)
            await runner.test('Level 1 lockout after 3 attempts', async () => {
                await lockoutManager.reset();
                
                // Record 3 failures
                await lockoutManager.recordFailure();
                await lockoutManager.recordFailure();
                const result = await lockoutManager.recordFailure();
                
                runner.assertEqual(result.level, 1, 'Level should be 1 after 3 failures');
                runner.assertEqual(result.isLockedOut, true, 'Should be locked out');
                
                const state = lockoutManager.getState();
                runner.assertEqual(state.failureCount, 3, 'Failure count should be 3');
                runner.assertGreaterThan(state.remainingLockoutTime, 0, 'Should have remaining time');
                runner.assertLessThan(state.remainingLockoutTime, 31000, 'Time should be ~30 seconds');
            });
            
            // Test 4: Level 2 lockout (5 attempts)
            await runner.test('Level 2 lockout after 5 attempts', async () => {
                await lockoutManager.reset();
                
                // Record 5 failures
                for (let i = 0; i < 5; i++) {
                    await lockoutManager.recordFailure();
                }
                
                const state = lockoutManager.getState();
                runner.assertEqual(state.failureCount, 5, 'Failure count should be 5');
                runner.assertEqual(state.currentLevel, 2, 'Level should be 2');
                runner.assertEqual(state.isLockedOut, true, 'Should be locked out');
                
                const time = state.remainingLockoutTime;
                runner.assertGreaterThan(time, 4 * 60 * 1000, 'Time should be ~5 minutes');
                runner.assertLessThan(time, 5.1 * 60 * 1000, 'Time should be ~5 minutes');
            });
            
            // Test 5: Level 3 threshold (10 attempts)
            await runner.test('Level 3 reached after 10 attempts', async () => {
                await lockoutManager.reset();
                
                // Record 10 failures
                for (let i = 0; i < 10; i++) {
                    await lockoutManager.recordFailure();
                }
                
                const state = lockoutManager.getState();
                runner.assertEqual(state.failureCount, 10, 'Failure count should be 10');
                runner.assertEqual(state.currentLevel, 3, 'Level should be 3');
            });
            
            // Test 6: Successful unlock clears state
            await runner.test('Successful unlock clears lockout state', async () => {
                await lockoutManager.reset();
                
                // Record some failures
                await lockoutManager.recordFailure();
                await lockoutManager.recordFailure();
                await lockoutManager.recordFailure();
                
                // Verify locked out
                runner.assert(lockoutManager.isLockedOut(), 'Should be locked out before success');
                
                // Record success
                await lockoutManager.recordSuccess();
                
                // Verify cleared
                const state = lockoutManager.getState();
                runner.assertEqual(state.failureCount, 0, 'Failure count should be reset');
                runner.assertEqual(state.isLockedOut, false, 'Should not be locked out');
            });
            
            // Test 7: State persistence
            await runner.test('State persists across reloads', async () => {
                await lockoutManager.reset();
                
                // Set up state
                await lockoutManager.recordFailure();
                await lockoutManager.recordFailure();
                
                // Save and reload
                await lockoutManager.saveState();
                await lockoutManager.loadState();
                
                const state = lockoutManager.getState();
                runner.assertEqual(state.failureCount, 2, 'Failure count should persist');
            });
            
            // Test 8: Encryption/decryption
            await runner.test('State is encrypted in storage', async () => {
                await lockoutManager.reset();
                await lockoutManager.recordFailure();
                await lockoutManager.saveState();
                
                // Try to read raw data
                const encrypted = await storageUtils.loadData('settings', 'lockout_state');
                
                runner.assert(encrypted, 'Encrypted data should exist');
                runner.assert(typeof encrypted === 'string' || typeof encrypted.value === 'string', 
                    'Data should be encrypted string');
            });
            
            // Test 9: Format lockout time
            await runner.test('Format lockout time correctly', () => {
                runner.assertEqual(
                    lockoutManager.formatLockoutTime(15000),
                    '15 seconds',
                    'Should format seconds'
                );
                runner.assertEqual(
                    lockoutManager.formatLockoutTime(90000),
                    '2 minutes',
                    'Should format minutes'
                );
                runner.assertEqual(
                    lockoutManager.formatLockoutTime(5 * 60 * 1000),
                    '5 minutes',
                    'Should format 5 minutes'
                );
            });
            
            // Test 10: Lockout messages
            await runner.test('Get correct lockout messages', () => {
                const msg1 = lockoutManager.getLockoutMessage(1);
                runner.assert(msg1.includes('30 seconds'), 'Level 1 message should mention 30 seconds');
                
                const msg2 = lockoutManager.getLockoutMessage(2);
                runner.assert(msg2.includes('5 minutes'), 'Level 2 message should mention 5 minutes');
                
                const msg3 = lockoutManager.getLockoutMessage(3);
                runner.assert(msg3.includes('CRITICAL'), 'Level 3 message should be critical');
                runner.assert(msg3.includes('10 failed'), 'Level 3 message should mention 10 attempts');
            });
            
            // Test 11: Auto-reset after 24 hours (simulated)
            await runner.test('Auto-reset after 24 hours', async () => {
                await lockoutManager.reset();
                
                // Set up failures
                await lockoutManager.recordFailure();
                await lockoutManager.recordFailure();
                
                // Manually set last reset time to 25 hours ago
                lockoutManager.state.lastResetTime = Date.now() - (25 * 60 * 60 * 1000);
                await lockoutManager.saveState();
                
                // Check auto-reset
                await lockoutManager.checkAutoReset();
                
                const state = lockoutManager.getState();
                runner.assertEqual(state.failureCount, 0, 'Should auto-reset after 24 hours');
            });
            
            // Test 12: Lockout expires
            await runner.test('Lockout expires after duration', async () => {
                await lockoutManager.reset();
                
                // Set up lockout with past expiry
                lockoutManager.state.failureCount = 3;
                lockoutManager.state.lockedUntil = Date.now() - 1000; // Expired 1 second ago
                
                runner.assertEqual(lockoutManager.isLockedOut(), false, 
                    'Should not be locked out after expiry');
                runner.assertEqual(lockoutManager.getRemainingLockoutTime(), 0,
                    'Remaining time should be 0');
            });
            
            console.log('All tests completed!');
            runner.renderResults();
        }
        
        async function clearTestData() {
            await lockoutManager.reset();
            console.log('Test data cleared');
            alert('Test data cleared! Run tests again to verify clean state.');
        }
        
        // Auto-run tests on load
        window.addEventListener('load', () => {
            console.log('Page loaded, ready to run tests');
        });
    </script>
</body>
</html>
