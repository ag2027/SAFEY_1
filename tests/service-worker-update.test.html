<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Update Flow Tests</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4A90E2;
            padding-bottom: 10px;
        }
        .test-suite {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #ddd;
            background: #fafafa;
        }
        .test-case.pass {
            border-left-color: #4CAF50;
            background: #f1f8f4;
        }
        .test-case.fail {
            border-left-color: #f44336;
            background: #fef5f5;
        }
        .test-name {
            font-weight: bold;
            margin-bottom: 8px;
        }
        .test-result {
            font-size: 0.9em;
            color: #666;
        }
        .test-error {
            color: #f44336;
            margin-top: 5px;
            font-family: monospace;
            font-size: 0.85em;
        }
        .summary {
            background: #333;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .summary.success {
            background: #4CAF50;
        }
        .summary.failure {
            background: #f44336;
        }
    </style>
</head>
<body>
    <h1>Service Worker Update Flow Tests</h1>
    <div id="test-results"></div>
    <div id="summary" class="summary"></div>

    <script>
        const results = [];
        
        function assert(condition, message) {
            if (!condition) {
                throw new Error(message);
            }
        }
        
        function runTest(name, testFn) {
            const testCase = document.createElement('div');
            testCase.className = 'test-case';
            
            const testName = document.createElement('div');
            testName.className = 'test-name';
            testName.textContent = name;
            testCase.appendChild(testName);
            
            const testResult = document.createElement('div');
            testResult.className = 'test-result';
            
            try {
                testFn();
                testCase.classList.add('pass');
                testResult.textContent = '✓ PASS';
                results.push({ name, passed: true });
            } catch (error) {
                testCase.classList.add('fail');
                testResult.textContent = '✗ FAIL';
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'test-error';
                errorDiv.textContent = error.message;
                testCase.appendChild(errorDiv);
                
                results.push({ name, passed: false, error: error.message });
            }
            
            testCase.appendChild(testResult);
            document.getElementById('test-results').appendChild(testCase);
        }
        
        function showSummary() {
            const total = results.length;
            const passed = results.filter(r => r.passed).length;
            const failed = total - passed;
            
            const summary = document.getElementById('summary');
            summary.textContent = `${passed}/${total} tests passed`;
            if (failed === 0) {
                summary.className = 'summary success';
            } else {
                summary.className = 'summary failure';
            }
        }
        
        // Test Suite
        const testSuite = document.createElement('div');
        testSuite.className = 'test-suite';
        testSuite.innerHTML = '<h2>Service Worker Path and Cache Tests</h2>';
        document.getElementById('test-results').appendChild(testSuite);
        
        // Test 1: Service worker base path detection
        runTest('Service worker should detect GitHub Pages base path', () => {
            // Mock the getBasePath function from service-worker.js
            const getBasePath = (pathname, isDevelopment) => {
                const match = pathname.match(/^(\/[^\/]+)\//);
                if (match && !isDevelopment) {
                    return match[1] + '/';
                }
                return '/';
            };
            
            assert(getBasePath('/SAFEY_1/service-worker.js', false) === '/SAFEY_1/', 
                   'Should extract /SAFEY_1/ from GitHub Pages URL');
            assert(getBasePath('/service-worker.js', false) === '/', 
                   'Should return / for root domain');
            assert(getBasePath('/SAFEY_1/service-worker.js', true) === '/', 
                   'Should return / in development mode');
        });
        
        // Test 2: Cache version updated
        runTest('Cache version should be v2', async () => {
            const response = await fetch('/service-worker.js');
            const text = await response.text();
            assert(text.includes("'safey-v2'"), 'Cache version should be v2');
        });
        
        // Test 3: SKIP_WAITING message handler exists
        runTest('Service worker should have SKIP_WAITING message handler', async () => {
            const response = await fetch('/service-worker.js');
            const text = await response.text();
            assert(text.includes('SKIP_WAITING'), 'Should have SKIP_WAITING handler');
            assert(text.includes("addEventListener('message'"), 'Should have message event listener');
        });
        
        // Test 4: App.js has update flow
        runTest('App should have service worker update flow', async () => {
            const response = await fetch('/app.js');
            const text = await response.text();
            assert(text.includes('handleWaitingServiceWorker'), 'Should have update handler function');
            assert(text.includes('updatefound'), 'Should listen for updatefound event');
            assert(text.includes('controllerchange'), 'Should listen for controllerchange event');
        });
        
        // Test 5: Update notification
        runTest('App should notify user of updates', async () => {
            const response = await fetch('/app.js');
            const text = await response.text();
            assert(text.includes('new version'), 'Should mention new version in notification');
            assert(text.includes('confirm('), 'Should use confirm dialog');
        });
        
        // Test 6: Manifest uses relative start_url
        runTest('Manifest should use relative start_url', async () => {
            const response = await fetch('/manifest.json');
            const manifest = await response.json();
            assert(manifest.start_url === './', 'start_url should be relative (./)');
        });
        
        // Test 7: Service worker registration path detection
        runTest('App should detect correct service worker path', async () => {
            const response = await fetch('/app.js');
            const text = await response.text();
            assert(text.includes('getServiceWorkerPath'), 'Should have SW path detection');
            assert(text.includes('endsWith'), 'Should use secure hostname check');
        });
        
        // Test 8: BASE_PATH used in cached URLs
        runTest('Service worker should use BASE_PATH for cached URLs', async () => {
            const response = await fetch('/service-worker.js');
            const text = await response.text();
            assert(text.includes('BASE_PATH +'), 'Should concatenate BASE_PATH with cached URLs');
            assert(!text.includes("'/'"), 'Should not have hardcoded root paths');
        });
        
        // Show summary
        setTimeout(showSummary, 100);
    </script>
</body>
</html>
